<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentFlow — Pipeline Studio</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2129;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --yellow: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
    --cyan: #39d2c0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .container { max-width: 1400px; margin: 0 auto; padding: 20px 24px; }

  /* ── Header ── */
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }
  header h1 { font-size: 20px; font-weight: 600; color: var(--accent); }
  header .tag {
    font-size: 11px; padding: 2px 8px; border-radius: 12px;
    background: var(--surface); border: 1px solid var(--border); color: var(--text-dim);
  }

  /* ── Presets ── */
  .presets { margin-bottom: 16px; }
  .presets-label {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-dim); margin-bottom: 8px;
  }
  .preset-cards { display: flex; gap: 10px; flex-wrap: wrap; }
  .preset-card {
    flex: 1; min-width: 220px; padding: 12px 14px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    cursor: pointer; transition: all 0.2s; text-align: left;
  }
  .preset-card:hover { border-color: var(--accent); background: rgba(88,166,255,0.06); }
  .preset-card.active { border-color: var(--accent); background: rgba(88,166,255,0.1); }
  .preset-card .preset-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .preset-card .preset-desc { font-size: 11px; color: var(--text-dim); line-height: 1.4; }

  /* ── Input area ── */
  .input-area { display: flex; gap: 8px; margin-bottom: 16px; }
  .input-area textarea {
    flex: 1; padding: 10px 14px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: inherit; font-size: 14px;
    outline: none; transition: border-color 0.2s; resize: vertical; min-height: 72px;
  }
  .input-area textarea:focus { border-color: var(--accent); }
  .input-area textarea::placeholder { color: var(--text-dim); }

  .btn {
    padding: 10px 20px; border: none; border-radius: 8px;
    font-family: inherit; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-primary { background: var(--accent); color: var(--bg); }
  .btn-primary:hover { opacity: 0.9; }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-run { background: var(--green); color: var(--bg); }
  .btn-run:hover { opacity: 0.9; }
  .btn-run:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ── Stage Progress Bar ── */
  .stage-bar {
    display: flex; align-items: center; gap: 0;
    margin-bottom: 16px; padding: 10px 16px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
  }
  .stage-step {
    display: flex; align-items: center; gap: 8px; font-size: 12px;
    color: var(--text-dim); transition: color 0.3s;
  }
  .stage-step .dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--border); transition: all 0.3s;
    flex-shrink: 0;
  }
  .stage-step.active .dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: pulse 1.5s ease-in-out infinite; }
  .stage-step.done .dot { background: var(--green); }
  .stage-step.active { color: var(--accent); font-weight: 600; }
  .stage-step.done { color: var(--green); }
  .stage-connector {
    flex: 1; height: 2px; background: var(--border);
    margin: 0 10px; transition: background 0.3s;
  }
  .stage-connector.done { background: var(--green); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* ── Main 2-column layout ── */
  .layout {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 16px; margin-bottom: 16px;
  }
  @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

  .panel {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden; display: flex; flex-direction: column;
  }
  .panel-header {
    padding: 10px 14px; border-bottom: 1px solid var(--border);
    font-size: 12px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-dim);
    display: flex; align-items: center; gap: 8px;
  }
  .panel-header .status-dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--text-dim);
  }
  .panel-header .status-dot.active {
    background: var(--green); animation: pulse 1.5s ease-in-out infinite;
  }
  .btn-clear {
    margin-left: auto; padding: 3px 10px; font-size: 11px;
    font-family: inherit; font-weight: 600; background: transparent;
    color: var(--text-dim); border: 1px solid var(--border);
    border-radius: 5px; cursor: pointer; transition: all 0.2s;
  }
  .btn-clear:hover { color: var(--red); border-color: var(--red); }

  .panel-body {
    padding: 12px; overflow-y: auto; max-height: 500px; flex: 1;
  }

  /* ── Log entries ── */
  .log-entry {
    padding: 8px 10px; margin-bottom: 4px; border-radius: 6px;
    font-size: 12px; line-height: 1.5; border-left: 3px solid transparent;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .log-entry.stage { background: rgba(88,166,255,0.08); border-left-color: var(--accent); font-weight: 600; }
  .log-entry.llm { background: rgba(188,140,255,0.08); border-left-color: var(--purple); color: var(--text-dim); }
  .log-entry.llm-prompt { background: rgba(188,140,255,0.05); border-left-color: var(--purple); }
  .log-entry.llm-response { background: rgba(57,210,192,0.06); border-left-color: var(--cyan); }
  .log-entry.result { background: rgba(63,185,80,0.08); border-left-color: var(--green); }
  .log-entry.validation { border-left-color: var(--cyan); background: rgba(57,210,192,0.06); }
  .log-entry.match { background: rgba(210,153,34,0.08); border-left-color: var(--yellow); }
  .log-entry.error { background: rgba(248,81,73,0.08); border-left-color: var(--red); }
  .log-entry.complete { background: rgba(63,185,80,0.12); border-left-color: var(--green); font-weight: 600; }

  .log-entry .label {
    display: inline-block; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px;
    padding: 1px 5px; border-radius: 3px; margin-right: 6px;
  }
  .label-stage { background: var(--accent); color: var(--bg); }
  .label-llm { background: var(--purple); color: var(--bg); }
  .label-match { background: var(--yellow); color: var(--bg); }
  .label-create { background: var(--cyan); color: var(--bg); }
  .label-ok { background: var(--green); color: var(--bg); }
  .label-err { background: var(--red); color: var(--bg); }
  .label-done { background: var(--green); color: var(--bg); }

  .llm-detail {
    margin-top: 6px; padding: 8px 10px; background: var(--bg);
    border: 1px solid var(--border); border-radius: 4px;
    font-size: 11px; line-height: 1.5; max-height: 200px;
    overflow-y: auto; white-space: pre-wrap; word-break: break-word;
    color: var(--text-dim);
  }
  .llm-detail.system-prompt { border-left: 2px solid var(--purple); }
  .llm-detail.user-prompt { border-left: 2px solid var(--accent); }
  .llm-detail.raw-response { border-left: 2px solid var(--cyan); }
  .llm-meta { font-size: 10px; color: var(--text-dim); margin-top: 4px; opacity: 0.7; }

  /* ── Flowchart ── */
  .flowchart { display: flex; flex-direction: column; align-items: center; gap: 0; padding: 8px 0; }

  .flow-node {
    width: 90%; max-width: 340px; padding: 10px 14px;
    background: var(--bg); border: 2px solid var(--border); border-radius: 8px;
    font-size: 12px; cursor: pointer; transition: all 0.2s;
    position: relative;
  }
  .flow-node:hover { border-color: var(--accent); transform: translateY(-1px); }
  .flow-node.selected { border-color: var(--accent); box-shadow: 0 0 12px rgba(88,166,255,0.2); }
  .flow-node.type-llm { border-color: var(--purple); }
  .flow-node.type-llm:hover { border-color: var(--purple); box-shadow: 0 0 12px rgba(188,140,255,0.2); }
  .flow-node.type-llm.selected { border-color: var(--purple); box-shadow: 0 0 16px rgba(188,140,255,0.3); }
  .flow-node.type-python { border-color: var(--cyan); }
  .flow-node.type-python:hover { border-color: var(--cyan); box-shadow: 0 0 12px rgba(57,210,192,0.2); }
  .flow-node.type-python.selected { border-color: var(--cyan); box-shadow: 0 0 16px rgba(57,210,192,0.3); }

  .flow-node .node-header {
    display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
  }
  .flow-node .node-id { font-weight: 700; color: var(--accent); }
  .flow-node .type-badge {
    font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 3px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .type-badge.llm { background: var(--purple); color: var(--bg); }
  .type-badge.python { background: var(--cyan); color: var(--bg); }
  .flow-node .node-block { font-size: 11px; color: var(--text-dim); }
  .flow-node .node-inputs {
    font-size: 10px; color: var(--text-dim); margin-top: 4px; opacity: 0.7;
  }

  .flow-edge {
    display: flex; flex-direction: column; align-items: center;
    height: 28px; position: relative;
  }
  .flow-edge .edge-line {
    width: 2px; flex: 1; background: var(--border);
  }
  .flow-edge .edge-arrow {
    width: 0; height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 6px solid var(--border);
  }

  /* ── Block Catalog Cards ── */
  .catalog-section {
    margin-top: 16px;
  }
  .catalog-header {
    font-size: 12px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-dim); margin-bottom: 10px;
    display: flex; align-items: center; gap: 8px;
  }
  .catalog-header .count {
    font-size: 11px; padding: 1px 8px; border-radius: 10px;
    background: var(--surface); border: 1px solid var(--border);
  }
  .catalog-scroll {
    display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;
    scroll-behavior: smooth;
  }
  .catalog-scroll::-webkit-scrollbar { height: 6px; }
  .catalog-scroll::-webkit-scrollbar-track { background: var(--surface); border-radius: 3px; }
  .catalog-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .block-card {
    min-width: 300px; max-width: 360px; flex-shrink: 0;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden; transition: all 0.2s;
  }
  .block-card:hover { border-color: var(--accent); }
  .block-card.highlight { border-color: var(--accent); box-shadow: 0 0 16px rgba(88,166,255,0.15); }
  .block-card.type-llm { border-top: 3px solid var(--purple); }
  .block-card.type-python { border-top: 3px solid var(--cyan); }

  .block-card-header {
    padding: 12px 14px; display: flex; align-items: center; gap: 8px;
    border-bottom: 1px solid var(--border);
  }
  .block-card-header .block-name { font-size: 13px; font-weight: 600; }
  .block-card-header .cat-pill {
    font-size: 9px; padding: 1px 6px; border-radius: 8px;
    background: var(--bg); border: 1px solid var(--border);
    color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.3px;
    margin-left: auto;
  }

  .block-card-body { padding: 10px 14px; }
  .block-card-body .block-desc {
    font-size: 11px; color: var(--text-dim); line-height: 1.5;
    margin-bottom: 8px; max-height: 44px; overflow: hidden;
  }

  .block-card-body .schema-row {
    font-size: 10px; color: var(--text-dim); margin-bottom: 2px;
  }
  .schema-row .sk { color: var(--accent); }
  .schema-row .st { color: var(--yellow); }

  .block-expand {
    border-top: 1px solid var(--border); padding: 0;
  }
  .block-expand summary {
    padding: 8px 14px; font-size: 11px; color: var(--text-dim);
    cursor: pointer; user-select: none;
  }
  .block-expand summary:hover { color: var(--text); }
  .block-expand-content {
    padding: 0 14px 12px; font-size: 11px;
  }

  /* ── Code display ── */
  .code-block {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 10px 12px; font-size: 11px; line-height: 1.6;
    overflow-x: auto; white-space: pre; color: var(--text-dim);
    max-height: 300px; overflow-y: auto;
    counter-reset: line;
  }
  .code-block .line {
    display: block;
  }
  .code-block .line::before {
    counter-increment: line;
    content: counter(line);
    display: inline-block;
    width: 28px;
    text-align: right;
    margin-right: 12px;
    color: var(--border);
    user-select: none;
  }
  /* Syntax colors */
  .code-block .kw { color: var(--purple); }
  .code-block .str { color: var(--green); }
  .code-block .cmt { color: var(--text-dim); font-style: italic; }
  .code-block .fn { color: var(--accent); }
  .code-block .num { color: var(--yellow); }

  .prompt-block {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 10px 12px; font-size: 11px; line-height: 1.6;
    white-space: pre-wrap; word-break: break-word; color: var(--text-dim);
    max-height: 250px; overflow-y: auto;
  }
  .prompt-block .placeholder {
    background: rgba(188,140,255,0.15); color: var(--purple);
    padding: 0 3px; border-radius: 3px; font-weight: 600;
  }

  .btn-load-source {
    padding: 5px 12px; font-size: 11px; font-family: inherit;
    font-weight: 600; background: var(--surface2);
    color: var(--cyan); border: 1px solid var(--cyan);
    border-radius: 5px; cursor: pointer; transition: all 0.2s;
  }
  .btn-load-source:hover { background: rgba(57,210,192,0.1); }
  .btn-load-source:disabled { opacity: 0.5; cursor: not-allowed; }

  /* ── Inspector Panel ── */
  .inspector {
    margin-top: 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 10px;
    overflow: hidden; display: none;
  }
  .inspector.visible { display: block; animation: fadeIn 0.3s ease; }
  .inspector-header {
    padding: 10px 14px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .inspector-header .insp-title {
    font-size: 14px; font-weight: 600;
  }
  .inspector-header .insp-close {
    margin-left: auto; background: none; border: none; color: var(--text-dim);
    font-size: 18px; cursor: pointer; padding: 0 4px;
  }
  .inspector-header .insp-close:hover { color: var(--red); }

  .inspector-tabs {
    display: flex; border-bottom: 1px solid var(--border);
  }
  .inspector-tab {
    padding: 8px 16px; font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.3px;
    color: var(--text-dim); background: none; border: none;
    border-bottom: 2px solid transparent; cursor: pointer;
    font-family: inherit; transition: all 0.2s;
  }
  .inspector-tab:hover { color: var(--text); }
  .inspector-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .inspector-body { padding: 14px; max-height: 400px; overflow-y: auto; }

  .wiring-row {
    font-size: 12px; padding: 4px 0; color: var(--text-dim);
  }
  .wiring-row .wk { color: var(--accent); font-weight: 600; }
  .wiring-row .wv { color: var(--cyan); }

  /* ── Results ── */
  .run-section { margin-top: 16px; }
  .result-node {
    padding: 10px 14px; margin-bottom: 6px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; font-size: 12px;
  }
  .result-node .node-label {
    font-weight: 600; color: var(--accent); margin-bottom: 6px;
    display: flex; align-items: center; gap: 8px;
  }
  .result-node .node-label .block-name-tag {
    font-size: 10px; font-weight: 400; color: var(--text-dim);
  }
  .result-node pre {
    color: var(--text-dim); white-space: pre-wrap; word-break: break-word;
    background: var(--bg); padding: 8px 10px; border-radius: 4px;
    border: 1px solid var(--border); max-height: 200px; overflow-y: auto;
  }

  .empty-state {
    color: var(--text-dim); font-size: 13px; text-align: center;
    padding: 40px 20px;
  }
  .empty-icon { font-size: 28px; margin-bottom: 8px; display: block; opacity: 0.5; }

  .spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.6s linear infinite;
    vertical-align: middle; margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── JSON viewer ── */
  .json-view {
    font-size: 12px; white-space: pre-wrap; word-break: break-word;
    color: var(--text-dim); line-height: 1.6;
  }
  .json-view .key { color: var(--accent); }
  .json-view .str { color: var(--green); }
  .json-view .num { color: var(--yellow); }
  .json-view .bool { color: var(--purple); }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>AgentFlow</h1>
    <span class="tag">Pipeline Studio</span>
  </header>

  <div class="presets">
    <div class="presets-label">Quick Start</div>
    <div class="preset-cards">
      <div class="preset-card" onclick="selectPreset(0)">
        <div class="preset-title">AirPods Price Check</div>
        <div class="preset-desc">Look up the current price of AirPods, generate a budget within 5% of that price, then check if the price fits the budget and report the result.</div>
      </div>
      <div class="preset-card" onclick="selectPreset(1)">
        <div class="preset-title">Top News Ranker</div>
        <div class="preset-desc">Search major news outlets for yesterday's top stories, score each by coverage count, then compile an overall ranking with links.</div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <textarea id="intentInput" rows="3"
              placeholder="Describe what you want your agent to do..."></textarea>
    <button class="btn btn-primary" id="createBtn" onclick="createAgent()">Create Agent</button>
    <button class="btn btn-run" id="runBtn" onclick="runPipeline()" disabled>Run Pipeline</button>
  </div>

  <!-- Stage Progress Bar -->
  <div class="stage-bar" id="stageBar">
    <div class="stage-step" id="stage-decompose"><span class="dot"></span> Decompose</div>
    <div class="stage-connector" id="conn-1"></div>
    <div class="stage-step" id="stage-match"><span class="dot"></span> Match</div>
    <div class="stage-connector" id="conn-2"></div>
    <div class="stage-step" id="stage-create"><span class="dot"></span> Create</div>
    <div class="stage-connector" id="conn-3"></div>
    <div class="stage-step" id="stage-wire"><span class="dot"></span> Wire</div>
  </div>

  <!-- 2-column: Thinker Log | Pipeline Flowchart -->
  <div class="layout">
    <div class="panel">
      <div class="panel-header">
        <span class="status-dot" id="logDot"></span>
        Thinker Process Log
        <button class="btn-clear" onclick="clearThinker()">Clear</button>
      </div>
      <div class="panel-body" id="logPanel">
        <div class="empty-state">
          <span class="empty-icon">&#x1f9e0;</span>
          Enter an intent and click "Create Agent" to watch the Thinker work.
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span class="status-dot" id="pipelineDot"></span>
        Pipeline Flowchart
        <button class="btn-clear" onclick="clearPipeline()">Clear</button>
      </div>
      <div class="panel-body" id="pipelinePanel">
        <div class="empty-state">
          <span class="empty-icon">&#x26A1;</span>
          Pipeline will appear here after the Thinker completes.
        </div>
      </div>
    </div>
  </div>

  <!-- Block Catalog -->
  <div class="catalog-section" id="catalogSection" style="display:none">
    <div class="catalog-header">
      Block Catalog <span class="count" id="catalogCount">0</span>
    </div>
    <div class="catalog-scroll" id="catalogScroll"></div>
  </div>

  <!-- Inspector Panel -->
  <div class="inspector" id="inspector">
    <div class="inspector-header">
      <span class="type-badge" id="inspBadge"></span>
      <span class="insp-title" id="inspTitle">Block Inspector</span>
      <button class="insp-close" onclick="closeInspector()">&times;</button>
    </div>
    <div class="inspector-tabs" id="inspTabs"></div>
    <div class="inspector-body" id="inspBody"></div>
  </div>

  <!-- Run Results -->
  <div id="runResults"></div>
</div>

<script>
// ── State ──
let currentPipeline = null;
let blockDefs = {};     // block_id -> full block definition
let selectedBlock = null;
let sourceCache = {};   // block_id -> source code

const PRESETS = [
  "Look up the current price of AirPods, generate a budget that is within 5% above or below that price, then compare whether the AirPods price fits within the budget and report the verdict.",
  "Search the top stories from yesterday across BBC News, CNN, Reuters, and Associated Press. For each story, score it based on how many of these outlets covered it. Compile all scores into an overall ranking of the top stories sorted by coverage score, and output the ranking as a numbered list with the story headline, score, and a link to one of the covering articles for each entry."
];

const STAGE_ORDER = ['decompose', 'match', 'create', 'wire'];

function selectPreset(index) {
  document.getElementById('intentInput').value = PRESETS[index];
  document.querySelectorAll('.preset-card').forEach((card, i) => {
    card.classList.toggle('active', i === index);
  });
}

// ── Stage Bar ──
function resetStageBar() {
  STAGE_ORDER.forEach(s => {
    const el = document.getElementById('stage-' + s);
    if (el) { el.className = 'stage-step'; }
  });
  for (let i = 1; i <= 3; i++) {
    const c = document.getElementById('conn-' + i);
    if (c) c.className = 'stage-connector';
  }
}

function setStage(stage, status) {
  const el = document.getElementById('stage-' + stage);
  if (!el) return;
  if (status === 'running') {
    el.className = 'stage-step active';
  } else if (status === 'done') {
    el.className = 'stage-step done';
    // Mark connector before this stage as done
    const idx = STAGE_ORDER.indexOf(stage);
    if (idx > 0) {
      const conn = document.getElementById('conn-' + idx);
      if (conn) conn.className = 'stage-connector done';
    }
  }
}

// ── Log ──
function addLog(html, cls = '') {
  const panel = document.getElementById('logPanel');
  if (panel.querySelector('.empty-state')) panel.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'log-entry ' + cls;
  div.innerHTML = html;
  panel.appendChild(div);
  panel.scrollTop = panel.scrollHeight;
}

// ── Helpers ──
function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function syntaxHighlight(json) {
  if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
  return json
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/"([^"]+)"(?=\s*:)/g, '<span class="key">"$1"</span>')
    .replace(/: "([^"]*)"/g, ': <span class="str">"$1"</span>')
    .replace(/: (\d+\.?\d*)/g, ': <span class="num">$1</span>')
    .replace(/: (true|false|null)/g, ': <span class="bool">$1</span>');
}

function highlightPrompt(template) {
  return esc(template).replace(/\{(\w+)\}/g,
    '<span class="placeholder">{$1}</span>'
  );
}

function highlightPython(code) {
  const lines = esc(code).split('\n');
  return lines.map(line => {
    let highlighted = line
      // comments
      .replace(/(#.*)$/, '<span class="cmt">$1</span>')
      // strings (simple single and double quotes)
      .replace(/("(?:[^"\\]|\\.)*")/g, '<span class="str">$1</span>')
      .replace(/('(?:[^'\\]|\\.)*')/g, '<span class="str">$1</span>')
      // keywords
      .replace(/\b(def|class|import|from|return|if|elif|else|for|while|in|not|and|or|is|None|True|False|async|await|try|except|raise|with|as|yield|lambda|pass|break|continue)\b/g,
        '<span class="kw">$1</span>')
      // numbers (not inside already-highlighted spans)
      .replace(/\b(\d+\.?\d*)\b/g, '<span class="num">$1</span>');
    return '<span class="line">' + highlighted + '</span>';
  }).join('\n');
}

function getBlockType(blockDef) {
  if (!blockDef) return 'unknown';
  const et = blockDef.execution_type || '';
  if (et === 'python' || et === 'code') return 'python';
  return 'llm';
}

function schemaProps(schema) {
  if (!schema || !schema.properties) return [];
  return Object.entries(schema.properties).map(([k, v]) => ({
    key: k, type: v.type || 'any'
  }));
}

// ── Flowchart Rendering ──
function showPipeline(pipeline) {
  const panel = document.getElementById('pipelinePanel');
  if (!pipeline || !pipeline.nodes || pipeline.nodes.length === 0) {
    panel.innerHTML = '<div class="empty-state"><span class="empty-icon">&#x26A1;</span>No pipeline generated.</div>';
    return;
  }

  // Build adjacency from edges
  const edgeMap = {};
  (pipeline.edges || []).forEach(e => {
    edgeMap[e.from] = edgeMap[e.from] || [];
    edgeMap[e.from].push(e.to);
  });

  let html = '<div class="flowchart">';

  pipeline.nodes.forEach((node, i) => {
    const bd = blockDefs[node.block_id];
    const btype = bd ? getBlockType(bd) : 'unknown';
    const typeCls = btype === 'python' ? 'type-python' : (btype === 'llm' ? 'type-llm' : '');
    const badgeCls = btype === 'python' ? 'python' : 'llm';
    const badgeLabel = btype === 'python' ? 'PY' : 'LLM';
    const blockName = bd ? bd.name : node.block_id;

    // Input wiring preview
    const inputs = node.inputs || {};
    const inputKeys = Object.keys(inputs);
    const inputPreview = inputKeys.length > 0
      ? inputKeys.slice(0, 3).map(k => {
          const v = inputs[k];
          const short = typeof v === 'string' && v.length > 25 ? v.slice(0,25) + '...' : v;
          return `${k}: ${short}`;
        }).join(', ')
      : '';

    html += `<div class="flow-node ${typeCls}" data-node-id="${node.id}" data-block-id="${node.block_id}" onclick="selectFlowNode('${node.block_id}', this)">
      <div class="node-header">
        <span class="node-id">${node.id}</span>
        <span class="type-badge ${badgeCls}">${badgeLabel}</span>
        <span style="color:var(--text-dim);font-size:11px">${esc(blockName)}</span>
      </div>
      ${inputPreview ? `<div class="node-inputs">${esc(inputPreview)}</div>` : ''}
    </div>`;

    // Draw edge to next node
    if (i < pipeline.nodes.length - 1) {
      html += '<div class="flow-edge"><div class="edge-line"></div><div class="edge-arrow"></div></div>';
    }
  });

  html += '</div>';

  // Raw JSON collapsible
  html += `<details style="margin-top:12px">
    <summary style="cursor:pointer;color:var(--text-dim);font-size:11px">Raw Pipeline JSON</summary>
    <div class="json-view" style="margin-top:8px">${syntaxHighlight(pipeline)}</div>
  </details>`;

  panel.innerHTML = html;
}

// ── Block Catalog Rendering ──
function renderCatalog() {
  const ids = Object.keys(blockDefs);
  if (ids.length === 0) return;

  const section = document.getElementById('catalogSection');
  section.style.display = '';
  document.getElementById('catalogCount').textContent = ids.length;

  const scroll = document.getElementById('catalogScroll');
  let html = '';

  ids.forEach(id => {
    const bd = blockDefs[id];
    const btype = getBlockType(bd);
    const typeCls = btype === 'python' ? 'type-python' : 'type-llm';
    const badgeCls = btype === 'python' ? 'python' : 'llm';
    const badgeLabel = btype === 'python' ? 'PYTHON' : 'LLM';
    const category = bd.category || 'general';

    // Schema display
    const inProps = schemaProps(bd.input_schema);
    const outProps = schemaProps(bd.output_schema);

    // Expandable content
    let expandContent = '';
    if (btype === 'llm' && bd.prompt_template) {
      expandContent = `<div style="font-size:10px;color:var(--text-dim);margin-bottom:4px;font-weight:600">PROMPT TEMPLATE</div>
        <div class="prompt-block">${highlightPrompt(bd.prompt_template)}</div>`;
    } else if (btype === 'python') {
      expandContent = `<button class="btn-load-source" onclick="loadSource(event, '${id}')">Load Source Code</button>
        <div id="source-${id}"></div>`;
    }

    html += `<div class="block-card ${typeCls}" id="card-${id}">
      <div class="block-card-header">
        <span class="type-badge ${badgeCls}">${badgeLabel}</span>
        <span class="block-name">${esc(bd.name || id)}</span>
        <span class="cat-pill">${esc(category)}</span>
      </div>
      <div class="block-card-body">
        <div class="block-desc">${esc(bd.description || '')}</div>
        ${inProps.length > 0 ? '<div style="font-size:10px;font-weight:600;color:var(--text-dim);margin-bottom:2px">IN</div>' +
          inProps.map(p => `<div class="schema-row"><span class="sk">${p.key}</span>: <span class="st">${p.type}</span></div>`).join('') : ''}
        ${outProps.length > 0 ? '<div style="font-size:10px;font-weight:600;color:var(--text-dim);margin-top:4px;margin-bottom:2px">OUT</div>' +
          outProps.map(p => `<div class="schema-row"><span class="sk">${p.key}</span>: <span class="st">${p.type}</span></div>`).join('') : ''}
      </div>
      ${expandContent ? `<details class="block-expand"><summary>Details</summary><div class="block-expand-content">${expandContent}</div></details>` : ''}
    </div>`;
  });

  scroll.innerHTML = html;
}

// ── Load Source Code ──
async function loadSource(event, blockId) {
  event.stopPropagation();
  const container = document.getElementById('source-' + blockId);
  const btn = event.target;

  if (sourceCache[blockId]) {
    container.innerHTML = `<div class="code-block" style="margin-top:8px">${highlightPython(sourceCache[blockId])}</div>`;
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Loading...';

  try {
    const resp = await fetch(`/api/blocks/${blockId}/source`);
    if (!resp.ok) throw new Error('Not found');
    const data = await resp.json();
    sourceCache[blockId] = data.source;
    container.innerHTML = `<div class="code-block" style="margin-top:8px">${highlightPython(data.source)}</div>`;
    btn.textContent = 'Source Loaded';
  } catch (e) {
    container.innerHTML = `<div style="color:var(--red);font-size:11px;margin-top:4px">Could not load source: ${e.message}</div>`;
    btn.disabled = false;
    btn.textContent = 'Retry';
  }
}

// ── Flowchart Node Selection → Inspector ──
function selectFlowNode(blockId, nodeEl) {
  // Highlight the flow node
  document.querySelectorAll('.flow-node').forEach(n => n.classList.remove('selected'));
  if (nodeEl) nodeEl.classList.add('selected');

  // Highlight corresponding catalog card
  document.querySelectorAll('.block-card').forEach(c => c.classList.remove('highlight'));
  const card = document.getElementById('card-' + blockId);
  if (card) {
    card.classList.add('highlight');
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }

  // Find the node for wiring info
  const node = currentPipeline ? (currentPipeline.nodes || []).find(n => n.block_id === blockId) : null;
  openInspector(blockId, node);
}

// ── Inspector ──
function openInspector(blockId, node) {
  const bd = blockDefs[blockId];
  if (!bd) return;

  selectedBlock = blockId;
  const inspector = document.getElementById('inspector');
  inspector.classList.add('visible');

  const btype = getBlockType(bd);
  const badge = document.getElementById('inspBadge');
  badge.className = 'type-badge ' + (btype === 'python' ? 'python' : 'llm');
  badge.textContent = btype === 'python' ? 'PYTHON' : 'LLM';

  document.getElementById('inspTitle').textContent = bd.name || blockId;

  // Build tabs
  const tabs = ['Overview'];
  if (btype === 'llm' && bd.prompt_template) tabs.push('Prompt');
  if (btype === 'python') tabs.push('Code');
  tabs.push('I/O Schema');
  if (node && node.inputs) tabs.push('Wiring');

  const tabsEl = document.getElementById('inspTabs');
  tabsEl.innerHTML = tabs.map((t, i) =>
    `<button class="inspector-tab${i === 0 ? ' active' : ''}" onclick="switchInspTab(this, '${t}', '${blockId}')">${t}</button>`
  ).join('');

  showInspTab('Overview', blockId, node);
}

function switchInspTab(tabEl, tabName, blockId) {
  document.querySelectorAll('.inspector-tab').forEach(t => t.classList.remove('active'));
  tabEl.classList.add('active');
  const node = currentPipeline ? (currentPipeline.nodes || []).find(n => n.block_id === blockId) : null;
  showInspTab(tabName, blockId, node);
}

function showInspTab(tabName, blockId, node) {
  const body = document.getElementById('inspBody');
  const bd = blockDefs[blockId];
  if (!bd) return;

  const btype = getBlockType(bd);

  if (tabName === 'Overview') {
    body.innerHTML = `
      <div style="margin-bottom:8px"><b>ID:</b> <span style="color:var(--cyan)">${esc(bd.id)}</span></div>
      <div style="margin-bottom:8px"><b>Type:</b> ${btype.toUpperCase()}</div>
      <div style="margin-bottom:8px"><b>Category:</b> ${esc(bd.category || 'general')}</div>
      <div style="color:var(--text-dim);line-height:1.6">${esc(bd.description || 'No description.')}</div>
      ${bd.use_when ? `<div style="margin-top:8px;padding:8px;background:var(--bg);border-radius:4px;border:1px solid var(--border);font-size:11px;color:var(--text-dim)"><b style="color:var(--yellow)">Use when:</b> ${esc(bd.use_when)}</div>` : ''}
    `;
  } else if (tabName === 'Prompt') {
    body.innerHTML = `<div class="prompt-block">${highlightPrompt(bd.prompt_template || '')}</div>`;
  } else if (tabName === 'Code') {
    if (sourceCache[blockId]) {
      body.innerHTML = `<div class="code-block">${highlightPython(sourceCache[blockId])}</div>`;
    } else {
      body.innerHTML = `<button class="btn-load-source" onclick="loadSourceInspector('${blockId}')">Load Source Code</button><div id="insp-source"></div>`;
    }
  } else if (tabName === 'I/O Schema') {
    const inProps = schemaProps(bd.input_schema);
    const outProps = schemaProps(bd.output_schema);
    body.innerHTML = `
      <div style="font-weight:600;margin-bottom:6px;color:var(--accent)">Input Schema</div>
      ${inProps.length > 0 ? inProps.map(p => `<div class="schema-row" style="font-size:12px"><span class="sk">${p.key}</span>: <span class="st">${p.type}</span></div>`).join('') : '<div style="color:var(--text-dim);font-size:12px">No inputs</div>'}
      <div style="font-weight:600;margin-top:12px;margin-bottom:6px;color:var(--green)">Output Schema</div>
      ${outProps.length > 0 ? outProps.map(p => `<div class="schema-row" style="font-size:12px"><span class="sk">${p.key}</span>: <span class="st">${p.type}</span></div>`).join('') : '<div style="color:var(--text-dim);font-size:12px">No outputs</div>'}
    `;
  } else if (tabName === 'Wiring') {
    const inputs = node ? (node.inputs || {}) : {};
    const entries = Object.entries(inputs);
    body.innerHTML = entries.length > 0
      ? entries.map(([k, v]) =>
          `<div class="wiring-row"><span class="wk">${esc(k)}</span> &larr; <span class="wv">${esc(String(v))}</span></div>`
        ).join('')
      : '<div style="color:var(--text-dim);font-size:12px">No wiring info available.</div>';
  }
}

async function loadSourceInspector(blockId) {
  const container = document.getElementById('insp-source');
  try {
    const resp = await fetch(`/api/blocks/${blockId}/source`);
    if (!resp.ok) throw new Error('Not found');
    const data = await resp.json();
    sourceCache[blockId] = data.source;
    document.getElementById('inspBody').innerHTML = `<div class="code-block">${highlightPython(data.source)}</div>`;
  } catch (e) {
    if (container) container.innerHTML = `<div style="color:var(--red);font-size:11px;margin-top:4px">Could not load source</div>`;
  }
}

function closeInspector() {
  document.getElementById('inspector').classList.remove('visible');
  document.querySelectorAll('.flow-node').forEach(n => n.classList.remove('selected'));
  document.querySelectorAll('.block-card').forEach(c => c.classList.remove('highlight'));
  selectedBlock = null;
}

// ── SSE Event Handling ──
async function createAgent() {
  const intent = document.getElementById('intentInput').value.trim();
  if (!intent) return;

  const btn = document.getElementById('createBtn');
  const runBtn = document.getElementById('runBtn');
  btn.disabled = true;
  btn.textContent = 'Thinking...';
  runBtn.disabled = true;
  currentPipeline = null;
  blockDefs = {};
  sourceCache = {};
  selectedBlock = null;

  document.getElementById('logPanel').innerHTML = '';
  document.getElementById('pipelinePanel').innerHTML = '<div class="empty-state"><span class="spinner"></span> Building agent...</div>';
  document.getElementById('logDot').classList.add('active');
  document.getElementById('pipelineDot').classList.remove('active');
  document.getElementById('catalogSection').style.display = 'none';
  document.getElementById('catalogScroll').innerHTML = '';
  document.getElementById('inspector').classList.remove('visible');
  document.getElementById('runResults').innerHTML = '';
  resetStageBar();

  try {
    const resp = await fetch('/api/create-agent/stream', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({intent, user_id: 'demo_user'}),
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, {stream: true});

      const lines = buffer.split('\n');
      buffer = lines.pop();

      let eventType = '';
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.slice(6));
            handleEvent(eventType || data.type, data);
          } catch (e) { /* skip malformed */ }
        }
      }
    }
  } catch (err) {
    addLog(`<span class="label label-err">ERR</span> ${err.message}`, 'error');
  }

  document.getElementById('logDot').classList.remove('active');
  btn.disabled = false;
  btn.textContent = 'Create Agent';
}

function handleEvent(type, data) {
  switch (type) {
    case 'start':
      addLog(`<span class="label label-stage">START</span> Thinker started for: "${esc(data.intent)}"`, 'stage');
      break;

    case 'stage':
      setStage(data.stage, 'running');
      addLog(`<span class="label label-stage">${data.stage.toUpperCase()}</span> ${esc(data.message)}`, 'stage');
      break;

    case 'llm_prompt':
      addLog(
        `<span class="label label-llm">PROMPT</span> Sending to LLM for <b>${esc(data.stage)}</b>` +
        `<details><summary style="cursor:pointer;color:var(--text-dim);font-size:11px;margin-top:4px">System prompt</summary>` +
        `<div class="llm-detail system-prompt">${esc(data.system)}</div></details>` +
        `<details><summary style="cursor:pointer;color:var(--text-dim);font-size:11px;margin-top:4px">User prompt</summary>` +
        `<div class="llm-detail user-prompt">${esc(data.user)}</div></details>`,
        'llm-prompt'
      );
      break;

    case 'llm_response':
      addLog(
        `<span class="label label-ok">RESPONSE</span> LLM replied for <b>${esc(data.stage)}</b> ` +
        `<span class="llm-meta">(${data.elapsed_s}s)</span>` +
        `<details><summary style="cursor:pointer;color:var(--text-dim);font-size:11px;margin-top:4px">Raw response</summary>` +
        `<div class="llm-detail raw-response">${esc(data.raw)}</div></details>`,
        'llm-response'
      );
      break;

    case 'stage_result':
      setStage(data.stage, 'done');
      if (data.stage === 'decompose') {
        const blocks = data.required_blocks || [];
        let detail = blocks.map(b =>
          b.block_id
            ? `<b>${esc(b.block_id)}</b> - ${esc(b.reason || '')}`
            : `<b>${esc(b.suggested_id || '?')}</b> (NEW) - ${esc(b.description || '')}`
        ).join('<br>');
        addLog(`<span class="label label-ok">DECOMPOSE</span> Found ${data.count} blocks:<br>${detail}`, 'result');
      } else if (data.stage === 'match') {
        addLog(`<span class="label label-ok">MATCH</span> Matched: ${data.matched}, Missing: ${data.missing} -> next: <b>${esc(data.next)}</b>`, 'result');
      } else if (data.stage === 'create') {
        addLog(`<span class="label label-create">CREATE</span> Created: ${(data.created||[]).map(esc).join(', ')}`, 'result');
      } else if (data.stage === 'wire') {
        addLog(`<span class="label label-done">WIRE</span> Pipeline wired!`, 'result');
      }
      break;

    case 'match_found':
      if (data.block_def) blockDefs[data.block_id] = data.block_def;
      addLog(`<span class="label label-match">FOUND</span> ${esc(data.block_id)} - ${esc(data.name)}`, 'match');
      break;

    case 'match_missing':
      addLog(`<span class="label label-err">MISS</span> ${esc(data.block_id || data.suggested_id || '?')} - needs creation`, 'match');
      break;

    case 'creating_block':
      addLog(`<span class="label label-create">BUILD</span> <span class="spinner"></span> Creating block ${data.index+1}/${data.total}: <b>${esc(data.suggested_id)}</b> - ${esc(data.description)}`, 'llm');
      break;

    case 'block_created': {
      if (data.block_def) blockDefs[data.block_id] = data.block_def;
      const typeTag = data.execution_type === 'code' || data.execution_type === 'python' ? 'PYTHON' : 'LLM';
      addLog(`<span class="label label-ok">CREATED</span> ${esc(data.block_id)} (<b>${typeTag}</b>)`, 'result');
      break;
    }

    case 'validation':
      if (data.valid) {
        addLog(`<span class="label label-ok">VALID</span> ${esc(data.stage)} output passed validation`, 'validation');
      } else {
        addLog(`<span class="label label-err">INVALID</span> ${esc(data.stage)}: ${esc(data.error || '')}`, 'error');
      }
      break;

    case 'complete':
      addLog(`<span class="label label-done">DONE</span> Thinker complete - status: <b>${esc(data.status)}</b>`, 'complete');
      if (data.pipeline_json) {
        currentPipeline = data.pipeline_json;
        showPipeline(data.pipeline_json);
        renderCatalog();
        document.getElementById('runBtn').disabled = false;
        document.getElementById('pipelineDot').classList.add('active');
      }
      break;
  }
}

// ── Run Pipeline ──
async function runPipeline() {
  if (!currentPipeline) return;

  const btn = document.getElementById('runBtn');
  btn.disabled = true;
  btn.textContent = 'Running...';

  const resultsDiv = document.getElementById('runResults');
  resultsDiv.innerHTML = '<div class="run-section"><div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:8px"><span class="spinner"></span> Executing pipeline...</div></div>';

  try {
    const resp = await fetch('/api/pipeline/run', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({pipeline: currentPipeline, user_id: 'demo_user'}),
    });

    const result = await resp.json();

    // Build a node-id to block name map
    const nodeNameMap = {};
    if (currentPipeline.nodes) {
      currentPipeline.nodes.forEach(n => {
        const bd = blockDefs[n.block_id];
        nodeNameMap[n.id] = bd ? bd.name : n.block_id;
      });
    }

    let rhtml = '<div class="run-section"><div style="font-size:14px;font-weight:600;color:var(--green);margin-bottom:12px">Execution Results</div>';

    if (result.results) {
      for (const [nodeId, output] of Object.entries(result.results)) {
        const name = nodeNameMap[nodeId] || '';
        rhtml += `<div class="result-node">
          <div class="node-label">${esc(nodeId)} ${name ? `<span class="block-name-tag">${esc(name)}</span>` : ''}</div>
          <pre>${JSON.stringify(output, null, 2)}</pre>
        </div>`;
      }
    }

    if (result.log) {
      rhtml += `<details style="margin-top:8px">
        <summary style="cursor:pointer;color:var(--text-dim);font-size:11px">Execution Log</summary>
        <div class="json-view" style="margin-top:8px">${syntaxHighlight(result.log)}</div>
      </details>`;
    }

    rhtml += '</div>';
    resultsDiv.innerHTML = rhtml;

    addLog(`<span class="label label-done">EXEC</span> Pipeline executed - ${Object.keys(result.results || {}).length} node(s) completed`, 'complete');

  } catch (err) {
    addLog(`<span class="label label-err">ERR</span> Execution failed: ${err.message}`, 'error');
    resultsDiv.innerHTML = '';
  }

  btn.disabled = false;
  btn.textContent = 'Run Pipeline';
}

// ── Clear ──
function clearThinker() {
  document.getElementById('logPanel').innerHTML = '<div class="empty-state"><span class="empty-icon">&#x1f9e0;</span>Enter an intent and click "Create Agent" to watch the Thinker work.</div>';
  document.getElementById('logDot').classList.remove('active');
}

function clearPipeline() {
  document.getElementById('pipelinePanel').innerHTML = '<div class="empty-state"><span class="empty-icon">&#x26A1;</span>Pipeline will appear here after the Thinker completes.</div>';
  document.getElementById('pipelineDot').classList.remove('active');
  document.getElementById('runBtn').disabled = true;
  document.getElementById('catalogSection').style.display = 'none';
  document.getElementById('inspector').classList.remove('visible');
  document.getElementById('runResults').innerHTML = '';
  currentPipeline = null;
  blockDefs = {};
  sourceCache = {};
  resetStageBar();
}

// ── Keyboard ──
document.getElementById('intentInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); createAgent(); }
});

document.getElementById('intentInput').addEventListener('input', () => {
  document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
});
</script>

</body>
</html>
